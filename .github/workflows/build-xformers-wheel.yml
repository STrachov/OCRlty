name: Build xformers wheel

on:
  # Ручной запуск из вкладки Actions
  workflow_dispatch:

  # (Опционально) автозапуск, если пушится тег вида xformers-0.1.0
  push:
    tags:
      - "xformers-*"

jobs:
  build-xformers-wheel:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # нужно, чтобы заливать релиз

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
     
      - name: Build xformers wheel inside PyTorch CUDA image
        run: |
          mkdir -p dist
          docker run --rm \
            -v "$PWD/dist:/dist" \
            pytorch/pytorch:2.6.0-cuda12.4-cudnn9-devel \
            bash -lc "
              set -e
      
              apt-get update && apt-get install -y git ninja-build cmake python3.10-venv \
                && rm -rf /var/lib/apt/lists/*
      
              # Важно: используем системные site-packages, где уже есть torch+CUDA
              python -m venv /opt/venv --system-site-packages
      
              /opt/venv/bin/python -m pip install --no-cache-dir -U \
                pip wheel setuptools ninja cmake packaging
      
              export MAX_JOBS=4
              export FORCE_CUDA=1
              export TORCH_CUDA_ARCH_LIST='8.6'
      
              git clone --depth=1 https://github.com/facebookresearch/xformers.git /tmp/xformers
              cd /tmp/xformers
      
              /opt/venv/bin/python -m pip wheel -v . -w /dist
      
              # На всякий случай подчистим кэш pip, если он вдруг завёлся
              rm -rf /root/.cache/pip || true
            "

      - name: Upload wheel as artifact
        uses: actions/upload-artifact@v4
        with:
          name: xformers-wheel
          path: dist/*.whl

      - name: Create GitHub Release and upload wheel
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
